#!/bin/bash

if [ -f /etc/redhat-release ]; then
  release="redhat"
fi

_PKI_DIR=/etc/salt/pki
_SALT_ROOTFILES=/srv
_CURRENT_DIR=$(pwd)
_EPEL_RELEASE=http://ftp.linux.ncsu.edu/pub/epel/6/i386/epel-release-6-8.noarch.rpm


clean(){

  rpm -e $_EPEL_RELEASE
  yum remove -y salt-master
  yum remove -y salt-minion
  rm -rf /etc/salt

} &> /dev/null

salt_setup(){
    
  #Install necessary packages
  rpm -Uvh $_EPEL_RELEASE
  yum install -y salt-master
  yum install -y salt-minion
  yum install -y pysnmp
  yum install -y python-pyasn1

  #Backup and configure the minion's configuration file
  /bin/cp /etc/salt/minion /etc/salt/minion.pkged

	cat <<-EOF > /etc/salt/minion
	#Generated from bootstrap script

	master: $(hostname)
	id: $(hostname)
	EOF

  #Backup and configure the master's configuration file
  /bin/cp /etc/salt/master /etc/salt/master.pkged

	cat <<-EOF > /etc/salt/master
	#Generated from bootstrap script

	schedule:
	  highstate:
	    function: state.highstate
	    seconds: 0
	    minutes: 10
	    hours: 0 

	file_roots:
	  base:
	    - /srv/salt/base

	pillar_roots:
	  base:
	    - /srv/salt/pillars
	EOF

  # Let's create the necessary directories
  [ -d $_PKI_DIR/minion ] || mkdir -p $_PKI_DIR/minion && chmod 700 $_PKI_DIR/minion || return 1
  [ -d $_PKI_DIR/master/minions ] || mkdir -p $_PKI_DIR/master/minions && chmod 700 $_PKI_DIR/master/minions || return 1
  [ -d /srv/salt/base ] || mkdir -p /srv/salt/base && chmod 700 /srv/salt/base || return 1
  [ -d /srv/salt/pillars ] || mkdir -p /srv/salt/pillars && chmod 700 /srv/salt/pillars || return 1

  #And copy our awesome configuration files
  cp -r ./salt $_SALT_ROOTFILES
  
  #Generate keys and preseed master with its key
  salt-key --gen-keys="$_PKI_DIR"/minion/minion
  /bin/cp "$_PKI_DIR"/minion/minion.pub $_PKI_DIR/master/minions/$(hostname)
  /bin/rm -rf /tmp/$(hostname).p*

} &> /dev/null

salt_services_start(){

  chkconfig salt-master on
  service salt-master start
  chkconfig salt-minion on
  service salt-minion start

}


echo "Using current directory $_CURRENT_DIR"
echo -e "Salt master will be $(hostname)"
echo -e "State and pillar files for salt are located in $_SALT_ROOTFILES/salt"

echo -e "\nCleaning up previous installation"
clean

echo -e "Installing and configuring salt"
salt_setup

echo -e "Adapting system to our configuration"
awk -v hostname=$(hostname) '/^master.controller:/{$0="master.controller: " hostname}1' ./salt/pillars/_env.sls > $_SALT_ROOTFILES/salt/pillars/_env.sls

echo -e "Starting salt services...\n"
salt_services_start

echo -e "\nRunnig first instance of highstate... (might take a while)"
salt '*' state.highstate &> /dev/null

echo -e "\nDone!"

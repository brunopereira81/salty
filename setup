#!/bin/bash


#color: "Black" "Blue" "Green" "Cyan" "Red" "Magenta" "Yellow" "White"

_PKI_DIR=/etc/salt/pki
_SALT_ROOTFILES=/srv
_CURRENT_DIR=$(pwd)
_EPEL_RELEASE=http://ftp.linux.ncsu.edu/pub/epel/6/i386/epel-release-6-8.noarch.rpm
_CONTROLLER_NAME=""


echo -e "\n                   /\\___/\\"
echo -e "                   \\ -.- /"
echo -e "                   \`-.^.-'          **xCAT** "   
echo -e "                     /\"\  \n"
echo -e "“Cats are intended to teach us that not everything in nature has a purpose.” \n"

requirement_setup(){

  yum install -y yum-utils
  yum install -y ncurses 

}

xcat_repo_add(){

  rm -rf /etc/yum.repos.d/xCAT-Core.repo
  rm -rf /etc/yum.repos.d/xCAT-Deps.repo

	cat <<- EOF > /etc/yum.repos.d/xCAT-Core.repo
	[xcat-2-core]
	name=xCAT 2 Core packages
	baseurl=https://sourceforge.net/projects/xcat/files/yum/2.8/xcat-core
	enabled=1
	gpgcheck=1
	gpgkey=https://sourceforge.net/projects/xcat/files/yum/2.8/xcat-core/repodata/repomd.xml.key
	EOF

	cat <<- EOF > /etc/yum.repos.d/xCAT-Deps.repo
	[xcat-dep]
	name=xCAT 2 depedencies
	baseurl=https://sourceforge.net/projects/xcat/files/yum/xcat-dep/rh6/x86_64
	enabled=1
	gpgcheck=1
	gpgkey=https://sourceforge.net/projects/xcat/files/yum/xcat-dep/rh6/x86_64/repodata/repomd.xml.key
	EOF

}

xcat_cleanup(){

  echo -e "Cleaning up everything and re-installing"
  rm -rf /install
  rm -rf /root/.xcat
  rm -rf /tftpboot
  rm -rf /etc/apache2/conf.d/xcat.conf
  rm -rf /etc/httpd/conf.d/xcat.conf
  rm -rf /etc/xCATMN
  rm -rf /opt/xcat/
  rm -rf /etc/xcat

  xcat_repo_add

  for i in $(rpm -qa); do
    if [ "$(repoquery -i $i | grep Repository | awk '{print $3}')" == "xcat-2-core" ]; then
      echo -e "\n$(tput setf 5)[Removing]$(tput sgr0) $i\c"
      rpm -e --nodeps "$(repoquery -i $i | grep Name | awk '{print $3}')" &> /dev/null
    fi
    if [ "$(repoquery -i $i | grep Repository | awk '{print $3}')" == "xcat-dep" ]; then
      echo -e "\n$(tput setf 5)[Removing]$(tput sgr0) $i\c"
      rpm -e --nodeps "$(repoquery -i $i | grep Name | awk '{print $3}')" &> /dev/null
    fi
  done
  
  yum clean all
  yum install -y xCAT

}

xcat_remove(){

  echo -e "Removing previous files and directories"

  rm -rf /install
  rm -rf /root/.xcat
  rm -rf /tftpboot
  rm -rf /etc/apache2/conf.d/xcat.conf
  rm -rf /etc/httpd/conf.d/xcat.conf
  rm -rf /etc/xCATMN
  rm -rf /opt/xcat/
  rm -rf /etc/xcat

  echo -e "Restoring repository information"
  xcat_repo_add

  echo -e "Installing necessary packages and recreating files:\n"
  for i in $(rpm -qa); do
    if [ "$(repoquery -i $i | grep Repository | awk '{print $3}')" == "xcat-2-core" ]; then
      echo -e "$(tput setf 2)[Installing]$(tput sgr0) $i\c"
      yum reinstall -y "$(repoquery -i $i | grep Name | awk '{print $3}')" &> /dev/null
    fi
    if [ "$(repoquery -i $i | grep Repository | awk '{print $3}')" == "xcat-dep" ]; then
      echo -e "$(tput setf 2)[Installing]$(tput sgr0) $i\c"
      yum reinstall -y "$(repoquery -i $i | grep Name | awk '{print $3}')" &> /dev/null
    fi
  done

}

if [ "$1" == "clean" ]; then
xcat_cleanup
else
  requirement_setup
  if [ -n "$(rpm -qa | grep xCAT)" ]; then
    echo -e "Cleaning up previous xCAT installation:\n"
    xcat_remove
  else
    echo -e "Installing xCAT"
    xcat_repo_add
    yum install -y xCAT
  fi
fi
